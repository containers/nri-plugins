---
- name: Check if a custom kernel is required and available
  hosts: all
  vars:
    cached_kernel_pkgs_tarball: ""
    kernel_getsource: "{{ kernel_getsource }}"
    kernel_config: "{{ kernel_config }}"

  tasks:
    - name: Check if we have already built kernel in cache
      when: kernel_getsource != '' and kernel_config != ''
      block:
        - name: Expand kernel_getsource shorthands
          ansible.builtin.set_fact:
            kernel_getsource: >
              {% if kernel_getsource == 'vanilla'%}
              git clone --depth 1 https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git linux
              {% if kernel_getsource == 'mainline' %}
              git clone --depth 1 https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git linux
              {% else %}
              {{ kernel_getsource }}
              {% endif %}

        - name: Generate kernel Fedora packages tarball name
          ansible.builtin.set_fact:
            cached_kernel_pkgs_tarball: "{{ cache_dir }}/kernel.getsource_{{ kernel_getsource | regex_replace('[^a-zA-Z0-9-]+', '_') }}.config_{{ lookup('file', kernel_config) | hash('sha256') }}.rpms.tar"
          when: ansible_facts['distribution'] == "Fedora"

        - name: Generate kernel Ubuntu packages tarball name
          ansible.builtin.set_fact:
            cached_kernel_pkgs_tarball: "{{ cache_dir }}/kernel.getsource_{{ kernel_getsource | regex_replace('[^a-zA-Z0-9-]+', '_') }}.config_{{ lookup('file', kernel_config) | hash('sha256') }}.debs.tar"
          when: ansible_facts['distribution'] == "Ubuntu"

        - name: What is cached kernel tarball status?
          delegate_to: localhost
          stat:
            path: "{{ cached_kernel_pkgs_tarball }}"
          register: cached_kernel_stat

        - name: If we have a cached kernel, push it to vm, ready for install
          when: cached_kernel_stat.stat.exists
          synchronize:
            src: "{{ cached_kernel_pkgs_tarball }}"
            dest: "/home/vagrant/linux-pkgs.tar"
            use_ssh_args: true

        - name: If we do not have a cached kernel, fetch and build the kernel on vm
          when: not cached_kernel_stat.stat.exists
          block:
            - name: Install kernel_getsource dependencies
              become: yes
              ansible.builtin.package:
                pkg:
                  - git
                  - wget
                  - rsync
                state: present
                update_cache: true

            - name: Get kernel sources to vm:~/linux
              shell: "if ! [ -d linux ]; then {{ kernel_getsource }}; fi"

            - name: Copy kernel config to the vm
              synchronize:
                src: "{{ kernel_config }}"
                dest: "linux/.config"
                use_ssh_args: true

            - name: Build kernel pkgs on Fedora to vm:~/linux-pkgs.tar
              ansible.builtin.include_tasks: custom-kernel-fedora.yaml
              when: ansible_facts['distribution'] == "Fedora"

            - name: Build kernel pkgs on Ubuntu to vm:~/linux-pkgs.tar
              ansible.builtin.include_tasks: custom-kernel-ubuntu.yaml
              when: ansible_facts['distribution'] == "Ubuntu"

            - name: Cache built kernel packages on the host
              synchronize:
                src: "linux-pkgs.tar"
                dest: "{{ cached_kernel_pkgs_tarball }}"
                use_ssh_args: true
                mode: pull
