<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Architecture &mdash; NRI Plugins v0.7.1-120-gef4c84f3 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Testing" href="testing.html" />
    <link rel="prev" title="Developer’s Guide" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            NRI Plugins
          </a>
              <div class="version">
                devel
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Resource Policy Plugins</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setup.html">Setup and Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html">Dynamic Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../policy/index.html">Policies</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Architecture</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#components">Components</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="cpu-allocator.html">CPU Allocator</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../memory/index.html">Memory plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/index.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/containers/nri-plugins">Project GitHub repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NRI Plugins</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Resource Policy Plugins</a></li>
          <li class="breadcrumb-item"><a href="index.html">Developer’s Guide</a></li>
      <li class="breadcrumb-item active">Architecture</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/docs/resource-policy/developers-guide/architecture.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="architecture">
<h1>Architecture<a class="headerlink" href="#architecture" title="Permalink to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>NRI Resource Policy (later NRI-RP) plugin is an add-on for controlling
container resource allocation on Kubernetes nodes.</p>
<p>NRI-RP plugs in to the NRI interface provided by container runtime implementation.
The NRI-RP may alter the container resource allocation depending on
configuration.</p>
<p>NRI-RP keeps track of the states of all containers running on a Kubernetes
node. Whenever it receives a NRI request that results in changes to the
resource allocation of any container (container creation, deletion, or
resource assignment update request), NRI-RP runs the built-in policy
algorithm. This policy makes a decision about how the assignment of
resources should be updated. The policy can make changes to any
container in the system, not just the one associated with the received
NRI request. NRI-RP’s internal state tracking cache provides an abstraction
for modifying containers and the policy uses this abstraction for recording its
decisions.</p>
<p>Many aspects for NRI-RP are configurable. These include, for instance,
configuration of the resource assignment algorithm for the policy.</p>
<p>Although NRI-RP can be configured using a static configuration file,
the preferred way to configure all NRI-RP instances in a cluster is to use
Kubernetes custom resources.</p>
<p align="center">
<!-- # It's a pity the markdown ![]()-syntax does not support aligning... -->
<img src="figures/nri-resource-policy.png" title="Architecture Overview" width="75%">
</p>
</section>
<section id="components">
<h2>Components<a class="headerlink" href="#components" title="Permalink to this heading"></a></h2>
<section id="node-agent">
<h3><a class="reference external" href="https://github.com/containers/nri-plugins/tree/ef4c84f3c3729f8ad5afd931ea66cf32db250c33/pkg/resmgr/agent">Node Agent</a><a class="headerlink" href="#node-agent" title="Permalink to this heading"></a></h3>
<p>The node agent is a component internal to NRI-RP itself. All interactions
by NRI-RP with the Kubernetes Control Plane go through the node agent with
the node agent performing any direct interactions on behalf of NRI-RP.</p>
<p>The agent interface implements the following functionality:</p>
<ul class="simple">
<li><p>push updated external configuration data to NRI-RP</p></li>
<li><p>updating resource capacity of the node</p></li>
<li><p>getting, setting, or removing labels on the node</p></li>
<li><p>getting, setting, or removing annotations on the node</p></li>
<li><p>getting, setting, or removing taints on the node</p></li>
</ul>
<p>The config interface is defined and has its gRPC server running in
NRI-RP. The agent acts as a gRPC client for this interface. The low-level
cluster interface is defined and has its gRPC server running in the agent,
with the <a class="reference external" href="https://github.com/containers/nri-plugins/tree/ef4c84f3c3729f8ad5afd931ea66cf32db250c33/pkg/resmgr/agent">convenience layer</a> defined in NRI-RP.
NRI-RP acts as a gRPC client for the low-level plumbing interface.</p>
<p>Additionally, the stock node agent that comes with NRI-RP implements schemes
for:</p>
<ul class="simple">
<li><p>configuration management for all NRI-RP instances</p></li>
<li><p>management of dynamic adjustments to container resource assignments</p></li>
</ul>
</section>
<section id="resource-manager">
<h3><a class="reference external" href="https://github.com/containers/nri-plugins/tree/ef4c84f3c3729f8ad5afd931ea66cf32db250c33/pkg/resmgr/">Resource Manager</a><a class="headerlink" href="#resource-manager" title="Permalink to this heading"></a></h3>
<p>NRI-RP implements an event processing pipeline. In addition to NRI events,
it processes a set of other events that are not directly related to or the
result of NRI requests. These events are typically internally generated within
NRI-RP.</p>
<p>The Resource Manager component of NRI-RP implements the basic control
flow of the processing pipeline. It passes control to all the
necessary sub-components of NRI-RP at the various phases of processing a
request or an event. Additionally, it serializes the processing of these,
making sure there is at most one request or event being processed at any
point in time.</p>
<p>The high-level control flow of the request processing pipeline is as
follows:</p>
<p>A. If the request does not need policying, let it bypass the processing
pipeline; hand it off for logging, then relay it to the server and the
corresponding response back to the client.</p>
<p>B. If the request needs to be intercepted for policying, do the following:</p>
<ol class="arabic simple">
<li><p>Lock the processing pipeline serialization lock.</p></li>
<li><p>Look up/create cache objects (pod/container) for the request.</p></li>
<li><p>If the request has no resource allocation consequences, do proxying
(step 6).</p></li>
<li><p>Otherwise, invoke the policy layer for resource allocation:</p></li>
</ol>
<ul class="simple">
<li><p>Pass it on to the configured active policy, which will</p></li>
<li><p>Allocate resources for the container.</p></li>
<li><p>Update the assignments for the container in the cache.</p></li>
<li><p>Update any other containers affected by the allocation in the cache.</p></li>
</ul>
<ol class="arabic simple" start="5">
<li><p>Invoke the controller layer for post-policy processing, which will:</p></li>
</ol>
<ul class="simple">
<li><p>Collect controllers with pending changes in their domain of control</p></li>
<li><p>for each invoke the post-policy processing function corresponding to
the request.</p></li>
<li><p>Clear pending markers for the controllers.</p></li>
</ul>
<ol class="arabic simple" start="6">
<li><p>Proxy the request:</p></li>
</ol>
<ul class="simple">
<li><p>Relay the request to the server.</p></li>
<li><p>Send update requests for any additional affected containers.</p></li>
<li><p>Update the cache if/as necessary based on the response.</p></li>
<li><p>Relay the response back to the client.</p></li>
</ul>
<ol class="arabic simple" start="7">
<li><p>Release the processing pipeline serialization lock.</p></li>
</ol>
<p>The high-level control flow of the event processing pipeline is one of the
following, based on the event type:</p>
<ul class="simple">
<li><p>For policy-specific events:</p>
<ol class="arabic simple">
<li><p>Engage the processing pipeline lock.</p></li>
<li><p>Call policy event handler.</p></li>
<li><p>Invoke the controller layer for post-policy processing (same as step 5 for
requests).</p></li>
<li><p>Release the pipeline lock.</p></li>
</ol>
</li>
</ul>
</section>
<section id="cache">
<h3><a class="reference external" href="https://github.com/containers/nri-plugins/tree/ef4c84f3c3729f8ad5afd931ea66cf32db250c33/pkg/resmgr/cache/">Cache</a><a class="headerlink" href="#cache" title="Permalink to this heading"></a></h3>
<p>The cache is a shared internal storage location within NRI-RP. It tracks the
runtime state of pods and containers known to NRI-RP, as well as the state
of NRI-RP itself, including the active configuration and the state of the
active policy. The cache is saved to permanent storage in the filesystem and
is used to restore the runtime state of NRI-RP across restarts.</p>
<p>The cache provides functions for querying and updating the state of pods and
containers. This is the mechanism used by the active policy to make resource
assignment decisions. The policy simply updates the state of the affected
containers in the cache according to the decisions.</p>
<p>The cache’s ability to associate and track changes to containers with
resource domains is used to enforce policy decisions. The generic controller
layer first queries which containers have pending changes, then invokes each
controller for each container. The controllers use the querying functions
provided by the cache to decide if anything in their resource/control domain
needs to be changed and then act accordingly.</p>
<p>Access to the cache needs to be serialized. However, this serialization is
not provided by the cache itself. Instead, it assumes callers to make sure
proper protection is in place against concurrent read-write access. The
request and event processing pipelines in the resource manager use a lock to
serialize request and event processing and consequently access to the cache.</p>
<p>If a policy needs to do processing unsolicited by the resource manager, IOW
processing other than handling the internal policy backend API calls from the
resource manager, then it should inject a policy event into the resource
managers event loop. This causes a callback from the resource manager to
the policy’s event handler with the injected event as an argument and with
the cache properly locked.</p>
</section>
<section id="generic-policy-layer">
<h3><a class="reference external" href="https://github.com/containers/nri-plugins/blob/ef4c84f3c3729f8ad5afd931ea66cf32db250c33/pkg/resmgr/policy/policy.go">Generic Policy Layer</a><a class="headerlink" href="#generic-policy-layer" title="Permalink to this heading"></a></h3>
<p>The generic policy layer defines the abstract interface the rest of NRI-RP
uses to interact with policy implementations and takes care of the details
of activating and dispatching calls through to the configured active policy.</p>
</section>
<section id="generic-resource-controller-layer">
<h3><a class="reference external" href="https://github.com/containers/nri-plugins/blob/ef4c84f3c3729f8ad5afd931ea66cf32db250c33/pkg/resmgr/control/control.go">Generic Resource Controller Layer</a><a class="headerlink" href="#generic-resource-controller-layer" title="Permalink to this heading"></a></h3>
<p>The generic resource controller layer defines the abstract interface the rest
of NRI-RP uses to interact with resource controller implementations and takes
care of the details of dispatching calls to the controller implementations
for post-policy enforcement of decisions.</p>
</section>
<section id="metrics-collector">
<h3><a class="reference external" href="https://github.com/containers/nri-plugins/tree/ef4c84f3c3729f8ad5afd931ea66cf32db250c33/pkg/metrics/">Metrics Collector</a><a class="headerlink" href="#metrics-collector" title="Permalink to this heading"></a></h3>
<p>The metrics collector gathers a set of runtime metrics about system resources,
containers running on the node, and policy-specific resource assignments and
expose these as Prometheus metrics. This data can be externally evaluated and
used to trigger rebalancing of resources if the NRI-RP implementation provides
a (policy-specific) external interface for this.</p>
</section>
<section id="policy-implementations">
<h3><a class="reference external" href="https://github.com/containers/nri-plugins/tree/ef4c84f3c3729f8ad5afd931ea66cf32db250c33/cmd/plugins">Policy Implementations</a><a class="headerlink" href="#policy-implementations" title="Permalink to this heading"></a></h3>
<section id="topology-aware">
<h4><a class="reference external" href="https://github.com/containers/nri-plugins/tree/ef4c84f3c3729f8ad5afd931ea66cf32db250c33/cmd/plugins/topology-aware/">Topology Aware</a><a class="headerlink" href="#topology-aware" title="Permalink to this heading"></a></h4>
<p>A topology-aware policy capable of handling multiple tiers/types of memory,
typically a DRAM/PMEM combination configured in 2-layer memory mode.</p>
</section>
<section id="balloons">
<h4><a class="reference external" href="https://github.com/containers/nri-plugins/tree/ef4c84f3c3729f8ad5afd931ea66cf32db250c33/cmd/plugins/balloons/">Balloons</a><a class="headerlink" href="#balloons" title="Permalink to this heading"></a></h4>
<p>A balloons policy allows user to define fine grained control how the
computer resources are distributed to workloads.</p>
</section>
<section id="template">
<h4><a class="reference external" href="https://github.com/containers/nri-plugins/tree/ef4c84f3c3729f8ad5afd931ea66cf32db250c33/cmd/plugins/template/">Template</a><a class="headerlink" href="#template" title="Permalink to this heading"></a></h4>
<p>The template policy can be used as a base for developing new policies.
It provides hooks that the policy developer can fill to define fine grained
control how the computer resources are distributed to workloads.
Do not edit the template policy directly but copy it to new name and edit that.</p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Developer’s Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="testing.html" class="btn btn-neutral float-right" title="Testing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, various.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
  
    <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
      <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> GitHub Pages</span>
        devel
        <span class="fa fa-caret-down"></span>
      </span>
      <div class="rst-other-versions">
        <dl id="versions">
          <dt>Versions</dt>
        </dl>
        <dl>
          <dt>
          <a href="/nri-plugins/releases">all releases</a>
          </dt>
        </dl>
      </div>
    </div>
  
  <script src="../../../../versions.js"></script>
  <script>
      var list = document.getElementById('versions')
      var menuItems = getVersionsMenuItems();
      for (var i=0; i < menuItems.length; i++) {
        var item = document.createElement('dd');
        var anchor = item.appendChild(document.createElement('a'));
        anchor.appendChild(document.createTextNode(menuItems[i].name));
        anchor.href = menuItems[i].url;
        list.appendChild(item);
      }
  </script>


</body>
</html>