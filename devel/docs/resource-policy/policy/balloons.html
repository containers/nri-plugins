<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Balloons Policy &mdash; NRI Plugins v0.12.0-23-gab2f7320 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=1bb285c9"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Template Policy" href="template.html" />
    <link rel="prev" title="Topology-Aware Policy" href="topology-aware.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            NRI Plugins
          </a>
              <div class="version">
                devel
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Resource Policy Plugins</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../setup.html">Setup and Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration.html">Dynamic Configuration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Policies</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="topology-aware.html">Topology-Aware Policy</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Balloons Policy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#installation-and-configuration">Installation and Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-options">Configuration Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cookbook">Cookbook</a></li>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="template.html">Template Policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="common-functionality.html">Common Functionality</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../developers-guide/index.html">Developer’s Guide</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../memory/index.html">Memory plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/index.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/containers/nri-plugins">Project GitHub repository</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NRI Plugins</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Resource Policy Plugins</a></li>
          <li class="breadcrumb-item"><a href="index.html">Policies</a></li>
      <li class="breadcrumb-item active">Balloons Policy</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/docs/resource-policy/policy/balloons.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="balloons-policy">
<h1>Balloons Policy<a class="headerlink" href="#balloons-policy" title="Link to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<section id="what-problems-does-the-balloons-policy-solve">
<h3>What Problems Does the Balloons Policy Solve?<a class="headerlink" href="#what-problems-does-the-balloons-policy-solve" title="Link to this heading"></a></h3>
<p>The balloons policy addresses CPU, device, and container affinity
requirements by organizing workloads into <strong>isolated CPU pools called
“balloons.”</strong> This approach solves several key challenges:</p>
<ul class="simple">
<li><p><strong>Flexible node resource partitioning</strong>: Isolates and regroups
containers from same or different pods, multi-pod applications and
namespaces to share balloons.</p></li>
<li><p><strong>Realtime requirements and latency-sensitivity</strong>: Minimizes
latencies by isolating critical workloads, tuning cache and physical
CPU core sharing, memory and device locality, CPU frequencies and
powersaving states, and process scheduling parameters, including
realtime scheduling policies and I/O priorities.</p></li>
<li><p><strong>Maximal server throughput</strong>: Optimizes resource utilization by
spreading memory and memory bandwidth hungry workloads across
sockets, NUMA nodes and cache domains. Tunes the balance of memory
accesses from lowest latency accesses to the closest memories only
towards maximal bandwidth by using more memory channels through
balanced cross-NUMA balloons within the same socket, or even more by
crossing socket boundaries. Controls allowed memory types (DRAM,
HBM, PMEM).</p></li>
<li><p><strong>Different workloads, different servers, different rules</strong>:
Allocates CPUs for different containers based on different CPU
allocation preferences. Preferences per worker node or worker node
group. Supports both pre-allocation of CPUs and on-demand
allocations as containers are created, and both always static and
dynamically growing/shrinking balloons.</p></li>
</ul>
</section>
<section id="organization-of-this-document">
<h3>Organization of this document<a class="headerlink" href="#organization-of-this-document" title="Link to this heading"></a></h3>
<p>This document is organized so you can either read it top-to-bottom or
jump directly to the sections below:</p>
<ul class="simple">
<li><p><strong><a class="reference internal" href="#integration-with-kubernetes">Integration with Kubernetes</a></strong></p></li>
<li><p><strong><a class="reference internal" href="#installation-and-configuration">Installation and Configuration</a></strong></p></li>
<li><p><strong><a class="reference internal" href="#configuration-options">Configuration Options</a></strong></p>
<ul>
<li><p><strong><a class="reference internal" href="#container-to-balloon-assignment">Container-to-Balloon Assignment</a></strong></p></li>
<li><p><strong><a class="reference internal" href="#cpus-to-balloon-selection">CPUs-to-Balloon Selection</a></strong></p></li>
<li><p><strong><a class="reference internal" href="#memories-to-balloon-selection">Memories-to-Balloon Selection</a></strong></p></li>
<li><p><strong><a class="reference internal" href="#container-tuning">Container Tuning</a></strong></p></li>
<li><p><strong><a class="reference internal" href="#cpu-tuning">CPU Tuning</a></strong></p></li>
<li><p><strong><a class="reference internal" href="#built-in-balloon-types">Built-in Balloon Types</a></strong></p></li>
<li><p><strong><a class="reference internal" href="#toggle-and-reset-pinning-memory-cpus-and-containers">Toggle and Reset Pinning Memory, CPUs, and Containers</a></strong></p></li>
<li><p><strong><a class="reference internal" href="#visibility-scheduling-metrics-logging-debugging">Visibility, Scheduling, Metrics, Logging, Debugging</a></strong></p></li>
</ul>
</li>
<li><p><strong><a class="reference internal" href="#cookbook">Cookbook</a></strong></p>
<ul>
<li><p><strong><a class="reference internal" href="#latency-critical-containers">Latency-Critical Containers</a></strong></p></li>
<li><p><strong><a class="reference internal" href="#maximum-memory-bandwidth-containers">Maximum Memory Bandwidth Containers</a></strong></p></li>
<li><p><strong><a class="reference internal" href="#workload-aware-hyperthread-sharing">Workload-Aware Hyperthread Sharing</a></strong></p></li>
</ul>
</li>
<li><p><strong><a class="reference internal" href="#troubleshooting">Troubleshooting</a></strong></p></li>
</ul>
</section>
<section id="integration-with-kubernetes">
<h3>Integration with Kubernetes<a class="headerlink" href="#integration-with-kubernetes" title="Link to this heading"></a></h3>
<p>The balloons policy integrates into the Kubernetes stack as an NRI
(Node Resource Interface) plugin that works with container runtimes
(containerd or CRI-O):</p>
<ol class="arabic simple">
<li><p><strong>Runtime Integration</strong>: Runs as a DaemonSet on each node,
intercepting container lifecycle events through NRI.</p></li>
<li><p><strong>Dynamic Configuration</strong>: Uses Kubernetes Custom Resources (CRs)
for configuration, supporting cluster-wide, node-group, and
node-specific settings.</p></li>
<li><p><strong>Pod Annotations</strong>: Allows fine-grained control through pod and
container annotations.</p></li>
<li><p><strong>Topology Awareness</strong>: Can expose balloon topology through
NodeResourceTopology CRs for scheduler integration and for
cluster-wide inspection of containers CPU affinity.</p></li>
</ol>
<p>The policy evaluates each container when it starts, assigns it to an
appropriate balloon based on configuration rules, and sets its CPU and
memory affinity accordingly.</p>
</section>
</section>
<section id="installation-and-configuration">
<h2>Installation and Configuration<a class="headerlink" href="#installation-and-configuration" title="Link to this heading"></a></h2>
<section id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Kubernetes 1.24+</p></li>
<li><p>Helm 3.0.0+</p></li>
<li><p>Container runtime with NRI support:</p>
<ul>
<li><p>containerd 1.7.0+ or CRI-O 1.26.0+</p></li>
<li><p>NRI feature enabled in the runtime (this is the default in
up-to-date runtimes).</p></li>
</ul>
</li>
</ul>
</section>
<section id="installing-with-helm">
<h3>Installing with Helm<a class="headerlink" href="#installing-with-helm" title="Link to this heading"></a></h3>
<p>Add the NRI plugins Helm repository:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>nri-plugins<span class="w"> </span>https://containers.github.io/nri-plugins
helm<span class="w"> </span>repo<span class="w"> </span>update
</pre></div>
</div>
<p>Install the balloons policy with default configuration:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>helm<span class="w"> </span>install<span class="w"> </span>nri-resource-policy-balloons<span class="w"> </span>nri-plugins/nri-resource-policy-balloons<span class="w"> </span>--namespace<span class="w"> </span>kube-system
</pre></div>
</div>
<p>Install with a custom configuration from a values file:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>&gt;<span class="w"> </span>balloons.values.helm.yaml<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">nri:</span>
<span class="s">  runtime:</span>
<span class="s">    patchConfig: true</span>
<span class="s">  plugin:</span>
<span class="s">    index: 10</span>

<span class="s">config:</span>
<span class="s">  agent:</span>
<span class="s">    nodeResourceTopology: true</span>
<span class="s">    podResourceAPI: false</span>
<span class="s">  allocatorTopologyBalancing: true</span>
<span class="s">  pinCPU: true</span>
<span class="s">  pinMemory: false</span>
<span class="s">  reservedResources:</span>
<span class="s">    cpu: cpuset:0</span>
<span class="s">  balloonTypes:</span>
<span class="s">  - name: high-priority</span>
<span class="s">    minCPUs: 4</span>
<span class="s">    maxCPUs: 8</span>
<span class="s">    namespaces:</span>
<span class="s">    - production</span>
<span class="s">    preferNewBalloons: true</span>
<span class="s">  control:</span>
<span class="s">    rdt:</span>
<span class="s">      enable: false</span>
<span class="s">      partitions:</span>
<span class="s">      options:</span>
<span class="s">  log:</span>
<span class="s">    debug:</span>
<span class="s">    - policy</span>
<span class="s">    klog:</span>
<span class="s">      skip_headers: true</span>
<span class="s">    source: true</span>
<span class="s">EOF</span>

helm<span class="w"> </span>install<span class="w"> </span>nri-resource-policy-balloons<span class="w"> </span>nri-plugins/nri-resource-policy-balloons<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-f<span class="w"> </span>balloons.values.helm.yaml
</pre></div>
</div>
</section>
<section id="uninstalling-with-helm">
<h3>Uninstalling with Helm<a class="headerlink" href="#uninstalling-with-helm" title="Link to this heading"></a></h3>
<p>Uninstalling will not restore CPU and memory pinning of running
containers. See <a class="reference internal" href="#reset-cpu-and-memory-pinning">Reset CPU and MemoryPinning</a>
to allow containers to use any CPU and memory again.</p>
<p>Uninstalling leaves behind the BalloonsPolicy custom resource
definition (CRD). Because installation skips installing new
BalloonsPolicy CRD if it already exists, it is recommended to manually
remove the CRD after uninstalling.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>helm<span class="w"> </span>uninstall<span class="w"> </span>nri-resource-policy-balloons<span class="w"> </span>-n<span class="w"> </span>kube-system

kubectl<span class="w"> </span>delete<span class="w"> </span>crd<span class="w"> </span>balloonspolicies.config.nri
</pre></div>
</div>
</section>
<section id="managing-configuration-with-kubectl">
<h3>Managing Configuration with kubectl<a class="headerlink" href="#managing-configuration-with-kubectl" title="Link to this heading"></a></h3>
<p>View the current balloons policy configuration:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># List all balloons policy configurations</span>
kubectl<span class="w"> </span>get<span class="w"> </span>balloonspolicies.config.nri<span class="w"> </span>-n<span class="w"> </span>kube-system

<span class="c1"># View the default configuration</span>
kubectl<span class="w"> </span>get<span class="w"> </span>balloonspolicies.config.nri/default<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>-o<span class="w"> </span>yaml
</pre></div>
</div>
<p>Edit the configuration:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>edit<span class="w"> </span>balloonspolicies.config.nri/default<span class="w"> </span>-n<span class="w"> </span>kube-system
</pre></div>
</div>
<p>The policy watches for configuration changes and automatically
reconfigures itself when the configuration is updated.</p>
</section>
<section id="configuration-scopes">
<h3>Configuration Scopes<a class="headerlink" href="#configuration-scopes" title="Link to this heading"></a></h3>
<p>The balloons policy supports three levels of configuration precedence:</p>
<ol class="arabic simple">
<li><p><strong>Default configuration</strong> (lowest precedence): Applies to all nodes
without more specific configuration</p>
<ul class="simple">
<li><p>Resource name: <code class="docutils literal notranslate"><span class="pre">default</span></code></p></li>
</ul>
</li>
<li><p><strong>Group-specific configuration</strong>: Applies to nodes labeled with a
configuration group</p>
<ul class="simple">
<li><p>Resource name: <code class="docutils literal notranslate"><span class="pre">group.$GROUP_NAME</span></code></p></li>
<li><p>Node label: <code class="docutils literal notranslate"><span class="pre">config.nri/group=$GROUP_NAME</span></code></p></li>
</ul>
</li>
<li><p><strong>Node-specific configuration</strong> (highest precedence): Applies to a
single named node</p>
<ul class="simple">
<li><p>Resource name: <code class="docutils literal notranslate"><span class="pre">node.$NODE_NAME</span></code></p></li>
</ul>
</li>
</ol>
<p><strong>Example</strong>: Create a group-specific configuration for high-memory nodes:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create the configuration</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">apiVersion: config.nri/v1alpha1</span>
<span class="s">kind: BalloonsPolicy</span>
<span class="s">metadata:</span>
<span class="s">  name: group.high-memory</span>
<span class="s">  namespace: kube-system</span>
<span class="s">spec:</span>
<span class="s">  reservedResources:</span>
<span class="s">    cpu: cpuset:0-1</span>
<span class="s">  balloonTypes:</span>
<span class="s">  - name: memory-intensive</span>
<span class="s">    shareIdleCPUsInSame: numa</span>
<span class="s">    maxBalloons: 4</span>
<span class="s">    preferNewBalloons: true</span>
<span class="s">    allocatorTopologyBalancing: true</span>
<span class="s">    namespaces:</span>
<span class="s">    - analytics</span>
<span class="s">EOF</span>

<span class="c1"># Label nodes to use this configuration</span>
kubectl<span class="w"> </span>label<span class="w"> </span>node<span class="w"> </span>node-1<span class="w"> </span>config.nri/group<span class="o">=</span>high-memory
kubectl<span class="w"> </span>label<span class="w"> </span>node<span class="w"> </span>node-2<span class="w"> </span>config.nri/group<span class="o">=</span>high-memory
</pre></div>
</div>
<p><strong>Example</strong>: Create a node-specific configuration:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">apiVersion: config.nri/v1alpha1</span>
<span class="s">kind: BalloonsPolicy</span>
<span class="s">metadata:</span>
<span class="s">  name: node.special-node</span>
<span class="s">  namespace: kube-system</span>
<span class="s">spec:</span>
<span class="s">  reservedResources:</span>
<span class="s">    cpu: 4000m</span>
<span class="s">  balloonTypes:</span>
<span class="s">  - name: gpu-workloads</span>
<span class="s">    preferCloseToDevices:</span>
<span class="s">      - /sys/class/drm/card0</span>
<span class="s">EOF</span>
</pre></div>
</div>
</section>
</section>
<section id="configuration-options">
<h2>Configuration Options<a class="headerlink" href="#configuration-options" title="Link to this heading"></a></h2>
<section id="core-concepts">
<h3>Core Concepts<a class="headerlink" href="#core-concepts" title="Link to this heading"></a></h3>
<p>A <strong>balloon</strong> is a set of CPUs shared by a set of containers. Key
principles:</p>
<ul class="simple">
<li><p>Every container is assigned to exactly one balloon.</p></li>
<li><p>Every CPU belongs to at most one balloon.</p></li>
<li><p>A container is allowed to use all CPUs in its balloon.</p></li>
<li><p>Optionally, containers can share “idle CPUs” (CPUs not in any
balloon).</p></li>
<li><p>Containers never access CPUs from other balloons.</p></li>
</ul>
</section>
<section id="container-to-balloon-assignment">
<h3>Container-to-Balloon Assignment<a class="headerlink" href="#container-to-balloon-assignment" title="Link to this heading"></a></h3>
<p>These options control which containers are assigned to which
balloons. The policy first chooses a balloon type for a container, and
then an existing or a new balloon instance of that type.</p>
<section id="choosing-balloon-type">
<h4>Choosing Balloon Type<a class="headerlink" href="#choosing-balloon-type" title="Link to this heading"></a></h4>
<p><strong>Balloon type selection for a new container:</strong></p>
<ol class="arabic simple">
<li><p>Balloon type effective for the container is specified by its pod
<a class="reference internal" href="#pod-annotations-for-container-overrides">annotation</a>. This skips
matching in user-defined and built-in balloon types. (Highest
precedence.)</p></li>
<li><p>Implicit <a class="reference internal" href="#reserved-balloon">built-in reserved balloon</a> type
matches kube-system containers, unless configured otherwise.</p></li>
<li><p>The first balloon type in the <code class="docutils literal notranslate"><span class="pre">balloonTypes</span></code> list where a
<code class="docutils literal notranslate"><span class="pre">matchExpression</span></code> or a <code class="docutils literal notranslate"><span class="pre">namespace</span></code> matches the container.</p></li>
<li><p>Implicit <a class="reference internal" href="#default-balloon">built-in default balloon</a> type matches
any container as a fallback, unless configured otherwise.</p></li>
<li><p>If no match, creating the container fails.</p></li>
</ol>
<p><strong><code class="docutils literal notranslate"><span class="pre">namespaces</span></code></strong> (list of strings)</p>
<ul class="simple">
<li><p>Assigns containers from matching namespaces to this balloon type.</p></li>
<li><p>Supports wildcards (e.g., <code class="docutils literal notranslate"><span class="pre">&quot;prod-*&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;*&quot;</span></code>).</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="w">  </span><span class="nt">namespaces</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod-*</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
</pre></div>
</div>
<p><strong><code class="docutils literal notranslate"><span class="pre">matchExpressions</span></code></strong> (list of expressions)</p>
<ul class="simple">
<li><p>Evaluates expressions against container attributes.</p></li>
<li><p>First balloon type with a matching expression is selected.</p></li>
<li><p>Supports keys:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> (container name)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">namespace</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">qosclass</span></code> (Guaranteed, Burstable or BestEffort)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">labels/KEY</span></code> (container’s label)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pod/name</span></code> (pod’s name)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pod/qosclass</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pod/labels/KEY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pod/id</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pod/uid</span></code></p></li>
</ul>
</li>
<li><p>Supports operators:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Equals</span></code>, <code class="docutils literal notranslate"><span class="pre">NotEqual</span></code>: key value is (not) equal to the only value</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">In</span></code>, <code class="docutils literal notranslate"><span class="pre">NotIn</span></code>: key value is (not) in listed values</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Exists</span></code>, <code class="docutils literal notranslate"><span class="pre">NotExists</span></code>: key is [not] present, values ignored</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AlwaysTrue</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Matches</span></code>, <code class="docutils literal notranslate"><span class="pre">MatchesNot</span></code>: key value matches (not) a single globbing pattern</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MatchesAny</span></code>, <code class="docutils literal notranslate"><span class="pre">MatchesNone</span></code>: key value matches any/none of a set of globbing patterns</p></li>
</ul>
</li>
</ul>
<p>Example: first pick logger and monitor containers into low-priority
balloons from any pod, including high and critical priority pods. Then
pick all (remaining) containers from high priority pods into
latency-critical balloons.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">low-priority</span>
<span class="w">  </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">    </span><span class="nt">values</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logger</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitor</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latency-critical</span>
<span class="w">  </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod/labels/priority</span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">    </span><span class="nt">values</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">high</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
</pre></div>
</div>
<p><strong>Composite balloons with <code class="docutils literal notranslate"><span class="pre">componentCreation:</span> <span class="pre">balance-balloons</span></code>:</strong></p>
<ul class="simple">
<li><p>When a balloon type has <code class="docutils literal notranslate"><span class="pre">components</span></code> list, <code class="docutils literal notranslate"><span class="pre">componentCreation</span></code>
enables controlling which component balloon types are used for
allocating its CPUs. The default is all of them.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">componentCreation:</span> <span class="pre">balance-balloons</span></code> creates only one component -
the one whose balloon type has the fewest instances.</p></li>
<li><p>Use this to alternate container assignments across multiple balloon
types.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">balanced-a-b</span>
<span class="w">  </span><span class="nt">components</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">balloonType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type-a</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">balloonType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type-b</span>
<span class="w">  </span><span class="nt">componentCreation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">balance-balloons</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type-a</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">type-b</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>
</div>
</section>
<section id="choosing-balloon-instance">
<h4>Choosing Balloon Instance<a class="headerlink" href="#choosing-balloon-instance" title="Link to this heading"></a></h4>
<p>Once the policy has chosen a balloon type for a container, following
options determine which instance of that type receives the container.</p>
<p>If no instance, new or existing, can get enough CPUs to fit the
container, the container creation fails.</p>
<p><strong><code class="docutils literal notranslate"><span class="pre">groupBy</span></code></strong> (string)</p>
<ul class="simple">
<li><p>Groups containers into the same balloon instance based on expression
evaluation.</p></li>
<li><p>Expression uses substitution: <code class="docutils literal notranslate"><span class="pre">${pod/labels/mylabel}</span></code> replaced with
label value. Substitution supports the keys as listed in
<code class="docutils literal notranslate"><span class="pre">matchExpressions</span></code> above.</p></li>
<li><p>Containers with the same expression value go to the same balloon.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-instances</span>
<span class="w">  </span><span class="nt">groupBy</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${pod/labels/app}-${pod/labels/instance}&quot;</span>
</pre></div>
</div>
<p><strong>Pod spreading options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">preferSpreadingPods:</span> <span class="pre">false</span></code> (default): Containers from the same pod
prefer the same balloon.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">preferSpreadingPods:</span> <span class="pre">true</span></code>: Containers from the same pod prefer
different balloons.</p></li>
</ul>
<p><strong>Namespace grouping:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">preferPerNamespaceBalloon:</span> <span class="pre">false</span></code> (default): Namespace has no
effect on balloon selection.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">preferPerNamespaceBalloon:</span> <span class="pre">true</span></code>: Containers in the same namespace
prefer the same balloon and different namespaces prefer different
balloons.</p></li>
</ul>
<p>Example: assign all containers into per-namespace balloons. Use the
same balloon type for every container by placing it before built-in
types in the list.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">per-namespace-balloon</span>
<span class="w">  </span><span class="nt">namespaces</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;*&quot;</span>
<span class="w">  </span><span class="nt">preferPerNamespaceBalloon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">allocatorTopologyBalancing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reserved</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
</pre></div>
</div>
<p><strong><code class="docutils literal notranslate"><span class="pre">preferNewBalloons</span></code></strong> (boolean, default: <code class="docutils literal notranslate"><span class="pre">false</span></code>)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">false</span></code>: Prefer filling existing balloons, inflate if needed up to
maximum size, create new balloon as last resort.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">true</span></code>: Prefer creating new balloons for exclusive CPU access (if
CPUs available).</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">exlusive-cpus</span>
<span class="w">  </span><span class="nt">allocatorTopologyBalancing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">preferNewBalloons</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
</section>
<section id="cpus-to-balloon-selection">
<h3>CPUs-to-Balloon Selection<a class="headerlink" href="#cpus-to-balloon-selection" title="Link to this heading"></a></h3>
<p>These options control which CPUs are selected when creating or
resizing balloons.</p>
<section id="static-cpu-preferences">
<h4>Static CPU Preferences<a class="headerlink" href="#static-cpu-preferences" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">preferIsolCpus</span></code></strong> (boolean, default: <code class="docutils literal notranslate"><span class="pre">false</span></code>)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">true</span></code>: Prefer kernel-isolated CPUs (from <code class="docutils literal notranslate"><span class="pre">isolcpus</span></code> kernel parameter)</p></li>
<li><p>Tip: use with <code class="docutils literal notranslate"><span class="pre">minCPUs</span></code>, <code class="docutils literal notranslate"><span class="pre">maxCPUs</span></code>, and <code class="docutils literal notranslate"><span class="pre">minBalloons</span></code> to
pre-allocate CPUs when using this option.</p></li>
<li><p>Warning: If insufficient isolated CPUs exist, balloons may include
non-isolated CPUs, too. If the application is unaware of this, it is
likely to cause unwanted Linux scheduling behavior.</p></li>
</ul>
<p>Example: pre-allocate two fixed-size one-CPU-balloons from
kernel-isolated CPUs.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kernel-isolated-cpu</span>
<span class="w">  </span><span class="nt">preferIsolCpus</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">minCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">maxCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">minBalloons</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</pre></div>
</div>
<p><strong><code class="docutils literal notranslate"><span class="pre">preferCoreType</span></code></strong> (string: <code class="docutils literal notranslate"><span class="pre">&quot;efficient&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;performance&quot;</span></code>)</p>
<ul class="simple">
<li><p>On hybrid architectures (P/E cores), prefers the specified core type.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;performance&quot;</span></code>: Select high-performance cores.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;efficient&quot;</span></code>: Select power-efficient cores.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">background-tasks</span>
<span class="w">  </span><span class="nt">preferCoreType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">efficient</span>
</pre></div>
</div>
<p><strong><code class="docutils literal notranslate"><span class="pre">preferCloseToDevices</span></code></strong> (list of strings)</p>
<ul class="simple">
<li><p>Prefers CPUs topologically close to specified devices.</p></li>
<li><p>Device paths like</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">/sys/class/net/eth0</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/sys/class/drm/card0</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/sys/devices/system/cpu/cpu14/cache/index2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/sys/devices/system/node/node0</span></code></p></li>
</ul>
</li>
<li><p>First device in list has highest priority.</p></li>
<li><p>Automatically adds anti-affinity between listed devices and other balloon types.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gpu-workloads</span>
<span class="w">  </span><span class="nt">preferCloseToDevices</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/class/drm/card0</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">network-io</span>
<span class="w">  </span><span class="nt">preferCloseToDevices</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/class/net/eth0</span>
</pre></div>
</div>
</section>
<section id="dynamic-cpu-preferences">
<h4>Dynamic CPU Preferences<a class="headerlink" href="#dynamic-cpu-preferences" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">allocatorTopologyBalancing</span></code></strong> (boolean, inherits from policy-level
setting if not specified)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">true</span></code>: Spread balloons across hardware topology (NUMA/die/package
with most free CPUs).</p>
<ul>
<li><p>Reduces interference when system is partially loaded.</p></li>
<li><p>Helps with future balloon inflation within same NUMA/die/package.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">false</span></code> (default): Pack balloons tightly into same hardware topology
elements.</p>
<ul>
<li><p>Keeps large portions of hardware idle for power saving.</p></li>
<li><p>More interference between balloons.</p></li>
</ul>
</li>
</ul>
<p><strong><code class="docutils literal notranslate"><span class="pre">preferSpreadOnPhysicalCores</span></code></strong> (boolean, inherits from policy-level
setting if not specified)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">true</span></code>: Allocate logical CPUs from separate physical cores</p>
<ul>
<li><p>Prevents containers from competing on same physical core resources.</p></li>
<li><p>Allows more interference between different balloons.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">false</span></code> (default): Pack logical CPUs tightly to minimum number of
physical cores</p>
<ul>
<li><p>Reduces inter-balloon interference.</p></li>
<li><p>Containers in the same balloon share physical core resources.</p></li>
</ul>
</li>
<li><p>Recommendation: use <code class="docutils literal notranslate"><span class="pre">loads</span></code> and <code class="docutils literal notranslate"><span class="pre">loadClasses</span></code> for better control in
sharing physical cores and low-level caches, and/or
<code class="docutils literal notranslate"><span class="pre">hideHyperthreads</span></code> to prevent any process in any balloon from using
the other hyperthread from the same physical core.</p></li>
</ul>
<p><strong><code class="docutils literal notranslate"><span class="pre">loads</span></code></strong> (list of strings)</p>
<ul class="simple">
<li><p>Marks logical CPUs and their surroundings (physical core, cache) as
loaded by certain balloons.</p></li>
<li><p>Avoids selecting CPUs from surroundings for other
same-load-generating balloons.</p></li>
<li><p>Every load is defined in <code class="docutils literal notranslate"><span class="pre">loadClasses</span></code> (see below).</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">compute-heavy</span>
<span class="w">  </span><span class="nt">loads</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">avx-compute</span>
</pre></div>
</div>
<p><strong><code class="docutils literal notranslate"><span class="pre">loadClasses</span></code></strong> (list, policy-level configuration):</p>
<p>Defines system load characteristics that balloons can generate. The
CPU allocator uses this information to avoid overloading hardware
resources.</p>
<p>Each load class defines:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> (string): Load class identifier (referenced in balloon types’
<code class="docutils literal notranslate"><span class="pre">loads</span></code> lists).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">level</span></code> (string): Hardware topology level affected:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;core&quot;</span></code>: Load affects physical CPU core resources.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;l2cache&quot;</span></code>: Load affects L2 cache block.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">overloadsLevelInBalloon</span></code> (boolean, default: <code class="docutils literal notranslate"><span class="pre">false</span></code>)</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">false</span></code>: CPUs within balloon can be from same core/cache (locality
prioritized).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">true</span></code>: CPUs within balloon should avoid same core/cache (avoid
self-interference).</p></li>
</ul>
</li>
</ul>
<p>How load classes affect CPU allocation:</p>
<ol class="arabic simple">
<li><p>Balloon type declares it generates certain loads.</p></li>
<li><p>When allocating CPUs for this balloon, allocator marks affected
topology levels as loaded.</p></li>
<li><p>When allocating CPUs for another balloon with the same load class
(same or different balloon type), allocator avoids loaded topology
levels.</p></li>
<li><p>Result: Balloons generating similar loads get CPUs from separate
cores/caches. Balloons generating different loads on same
cores/caches are allowed to share the same surroundings.</p></li>
</ol>
<p>Example: containers in <code class="docutils literal notranslate"><span class="pre">compute-heavy-1</span></code> and <code class="docutils literal notranslate"><span class="pre">compute-heavy-2</span></code>
balloons should get only one hyperthread from every physical core, and
they should not share physical cores. Containers in <code class="docutils literal notranslate"><span class="pre">light-compute</span></code>
are marked to load cores, too, but only to avoid taking both
hyperthreads from the same cores. This leaves the other hyperthread
free for compute heavy workloads. A <code class="docutils literal notranslate"><span class="pre">heavy-avx</span></code> and a <code class="docutils literal notranslate"><span class="pre">light-avx</span></code> load
can share the same physical core, but two <code class="docutils literal notranslate"><span class="pre">heavy-avx</span></code> or two
<code class="docutils literal notranslate"><span class="pre">light-avx</span></code> loads should not.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">compute-heavy-1</span>
<span class="w">  </span><span class="nt">loads</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">heavy-avx</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">compute-heavy-2</span>
<span class="w">  </span><span class="nt">loads</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">heavy-avx</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">light-compute</span>
<span class="w">  </span><span class="nt">loads</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">light-avx</span>

<span class="nt">loadClasses</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">heavy-avx</span>
<span class="w">  </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">core</span>
<span class="w">  </span><span class="nt">overloadsLevelInBalloon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># Each CPU from different physical core</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">light-avx</span>
<span class="w">  </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">core</span>
<span class="w">  </span><span class="nt">overloadsLevelInBalloon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># Spread on different physical cores</span>
<span class="w">                                </span><span class="c1"># to leave the other thread free for</span>
<span class="w">                                </span><span class="c1"># compute-heavy balloons</span>
</pre></div>
</div>
<p><strong><code class="docutils literal notranslate"><span class="pre">components</span></code></strong> (list of objects):</p>
<p>For balloons with diverse CPU requirements, use composite balloons
where each component specifies different requirements:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hybrid-workload</span>
<span class="w">  </span><span class="nt">components</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">balloonType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">near-gpu</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">balloonType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">near-network</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">near-gpu</span>
<span class="w">  </span><span class="nt">preferCloseToDevices</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/class/drm/card0</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">near-network</span>
<span class="w">  </span><span class="nt">preferCloseToDevices</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/class/net/eth0</span>
</pre></div>
</div>
</section>
<section id="balloon-size-control">
<h4>Balloon Size Control<a class="headerlink" href="#balloon-size-control" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">minCPUs</span></code></strong> (integer, default: 0)</p>
<ul class="simple">
<li><p>Minimum number of CPUs in any balloon of this type.</p></li>
<li><p>When balloon is created or deflated, it always has at least this many CPUs.</p></li>
<li><p>Useful for</p>
<ul>
<li><p>ensuring minimum performance guarantees</p></li>
<li><p>allocating exactly wanted number of special CPUs (from isolcpus,
reserved CPU set, efficient-cores, CPUs local to a device, …)</p></li>
<li><p>partitioning hardware block-by-block (take all CPUs from a
physical core, L2 cache domain, NUMA node, compute die or socket at
once.</p></li>
</ul>
</li>
</ul>
<p><strong><code class="docutils literal notranslate"><span class="pre">maxCPUs</span></code></strong> (integer, default: 0 = unlimited)</p>
<ul class="simple">
<li><p>Maximum number of CPUs in any balloon of this type.</p></li>
<li><p>Balloon will not inflate beyond this limit. The policy has to create
a new balloon instead.</p></li>
<li><p>Set to -1 to prevent containers matching this balloon from running
on the node (see cookbook).</p></li>
</ul>
<p><strong>Fully dynamic sizing:</strong></p>
<ul class="simple">
<li><p>Set <code class="docutils literal notranslate"><span class="pre">minCPUs:</span> <span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">maxCPUs:</span> <span class="pre">0</span></code> or leave them undefined.</p></li>
<li><p>Balloon size determined entirely by container CPU requests.</p></li>
</ul>
<p><strong>Fixed size:</strong></p>
<ul class="simple">
<li><p>Set <code class="docutils literal notranslate"><span class="pre">minCPUs</span></code> and <code class="docutils literal notranslate"><span class="pre">maxCPUs</span></code> to the same value.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fixed-quad</span>
<span class="w">  </span><span class="nt">minCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">  </span><span class="nt">maxCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamic-small</span>
<span class="w">  </span><span class="nt">minCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">maxCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unlimited</span>
<span class="w">  </span><span class="nt">minCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">maxCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</pre></div>
</div>
</section>
<section id="cpu-allocation-priority">
<h4>CPU Allocation Priority<a class="headerlink" href="#cpu-allocation-priority" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">minBalloons</span></code></strong> (integer, default: 0)</p>
<ul class="simple">
<li><p>Number of balloon instances pre-created when policy starts or
reconfigures. <code class="docutils literal notranslate"><span class="pre">allocatorPriority</span></code> and the order in the
<code class="docutils literal notranslate"><span class="pre">balloonTypes</span></code> list affect the order of instantiating <code class="docutils literal notranslate"><span class="pre">minBalloons</span></code>
of different balloon types (see below).</p></li>
<li><p>Ensures critical balloons always exist and have CPUs before other
balloons.</p></li>
<li><p>Yet new balloon instances of this type may be dynamically created
and destroyed, the number of instances never goes below
<code class="docutils literal notranslate"><span class="pre">minBalloons</span></code>.</p></li>
</ul>
<p><strong><code class="docutils literal notranslate"><span class="pre">maxBalloons</span></code></strong> (integer, default: 0 = unlimited)</p>
<ul class="simple">
<li><p>Maximum number of balloon instances allowed to co-exist.</p></li>
<li><p>Prevents creating new balloons beyond this limit.</p></li>
</ul>
<p><strong><code class="docutils literal notranslate"><span class="pre">allocatorPriority</span></code></strong> (string: <code class="docutils literal notranslate"><span class="pre">&quot;high&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;normal&quot;</span></code> (default), <code class="docutils literal notranslate"><span class="pre">&quot;low&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;none&quot;</span></code>)</p>
<ul class="simple">
<li><p>At policy initialization, balloons are pre-created in this order:</p>
<ol class="arabic simple">
<li><p>Balloon types with <code class="docutils literal notranslate"><span class="pre">priority:</span> <span class="pre">high</span></code> (in list order)</p></li>
<li><p>Balloon types with <code class="docutils literal notranslate"><span class="pre">priority:</span> <span class="pre">normal</span></code> (in list order)</p></li>
<li><p>Balloon types with <code class="docutils literal notranslate"><span class="pre">priority:</span> <span class="pre">low</span></code> (in list order)</p></li>
</ol>
</li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical-service</span>
<span class="w">  </span><span class="nt">minBalloons</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">maxBalloons</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">minCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">  </span><span class="nt">maxCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">  </span><span class="nt">allocatorPriority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">high</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">best-effort</span>
<span class="w">  </span><span class="nt">allocatorPriority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">low</span>
</pre></div>
</div>
</section>
</section>
<section id="memories-to-balloon-selection">
<h3>Memories-to-Balloon Selection<a class="headerlink" href="#memories-to-balloon-selection" title="Link to this heading"></a></h3>
<p>If <code class="docutils literal notranslate"><span class="pre">pinMemory:</span> <span class="pre">true</span></code>, the policy allows containers to use memory only
from NUMA nodes closest to their balloon’s CPUs. This node set may be
larger if there is not enough memory in the closest nodes
alone. Pinning can be fine-tuned to include only certain memory types
for certain balloons and containers.</p>
<p><strong><code class="docutils literal notranslate"><span class="pre">memoryTypes</span></code></strong> (list of strings):</p>
<ul class="simple">
<li><p>Restricts memory types available to containers: <code class="docutils literal notranslate"><span class="pre">&quot;DRAM&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;HBM&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;PMEM&quot;</span></code>.</p></li>
<li><p>Default: All memory types in system are allowed.</p></li>
<li><p>Can be overridden per container with <code class="docutils literal notranslate"><span class="pre">memory-type.resource-policy.nri.io</span></code> annotation.</p></li>
<li><p>Effective only when <code class="docutils literal notranslate"><span class="pre">pinMemory:</span> <span class="pre">true</span></code>.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">pinMemory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hbm-only</span>
<span class="w">  </span><span class="nt">memoryTypes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HBM</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">flexible</span>
<span class="w">  </span><span class="nt">memoryTypes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DRAM</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PMEM</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">pinMemory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
</section>
<section id="container-tuning">
<h3>Container Tuning<a class="headerlink" href="#container-tuning" title="Link to this heading"></a></h3>
<p>These options configure how containers behave within their balloons.</p>
<section id="scheduling-and-priority">
<h4>Scheduling and Priority<a class="headerlink" href="#scheduling-and-priority" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">schedulingClass</span></code></strong> (string)</p>
<ul class="simple">
<li><p>References a scheduling class defined in the <code class="docutils literal notranslate"><span class="pre">schedulingClasses</span></code>
list.</p></li>
<li><p>Sets Linux scheduling policy, priority, nice value, and I/O class
for containers.</p></li>
<li><p>Can be overridden with <code class="docutils literal notranslate"><span class="pre">scheduling-class.resource-policy.nri.io</span></code> pod
annotation.</p></li>
</ul>
<p><strong><code class="docutils literal notranslate"><span class="pre">schedulingClasses</span></code></strong> (list, policy-level configuration):</p>
<p>Each scheduling class defines:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> (string): Class name referenced by <code class="docutils literal notranslate"><span class="pre">schedulingClass</span></code> in
balloon types.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">policy</span></code> (string): Linux scheduling policy: <code class="docutils literal notranslate"><span class="pre">&quot;none&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;other&quot;</span></code>,
<code class="docutils literal notranslate"><span class="pre">&quot;fifo&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;rr&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;batch&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;idle&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;deadline&quot;</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">priority</span></code> (integer): Scheduling priority, depends on <code class="docutils literal notranslate"><span class="pre">policy</span></code>, see
<code class="docutils literal notranslate"><span class="pre">sched_setscheduler(2)</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flags</span></code> (list): Scheduling flags: <code class="docutils literal notranslate"><span class="pre">&quot;reset-on-fork&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;reclaim&quot;</span></code>,
<code class="docutils literal notranslate"><span class="pre">&quot;dl-overrun&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;keep-policy&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;keep-params&quot;</span></code>,
<code class="docutils literal notranslate"><span class="pre">&quot;util-clamp-min&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;util-clamp-max&quot;</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nice</span></code> (integer): Nice value for container process (-20 to 19).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">runtime</span></code> (integer): Runtime for deadline policy (microseconds).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deadline</span></code> (integer): Deadline for deadline policy (microseconds).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">period</span></code> (integer): Period for deadline policy (microseconds).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ioClass</span></code> (string): I/O class: <code class="docutils literal notranslate"><span class="pre">&quot;none&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;rt&quot;</span></code> (realtime), <code class="docutils literal notranslate"><span class="pre">&quot;be&quot;</span></code>
(best-effort), <code class="docutils literal notranslate"><span class="pre">&quot;idle&quot;</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ioPriority</span></code> (integer): I/O priority, see <code class="docutils literal notranslate"><span class="pre">ionice(1)</span></code>.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">high-priority</span>
<span class="w">  </span><span class="nt">schedulingClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="nt">schedulingClasses</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">  </span><span class="nt">policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rr</span>
<span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
<span class="w">  </span><span class="nt">ioClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rt</span>
<span class="w">  </span><span class="nt">ioPriority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">background</span>
<span class="w">  </span><span class="nt">policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">idle</span>
<span class="w">  </span><span class="nt">ioClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">idle</span>
</pre></div>
</div>
</section>
<section id="sharing-idle-cpus">
<h4>Sharing idle CPUs<a class="headerlink" href="#sharing-idle-cpus" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">shareIdleCPUsInSame</span></code></strong> (string: <code class="docutils literal notranslate"><span class="pre">&quot;system&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;package&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;die&quot;</span></code>,
<code class="docutils literal notranslate"><span class="pre">&quot;numa&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;l2cache&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;core&quot;</span></code>)</p>
<ul class="simple">
<li><p>Allows containers to use “idle CPUs” (not in any balloon) in
addition to balloon’s own CPUs.</p></li>
<li><p>Value sets locality constraint for which idle CPUs can be used, with
respect to balloon’s own CPUs.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;system&quot;</span></code>: All idle CPUs in the system.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;package&quot;</span></code>: Idle CPUs in same socket(s).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;die&quot;</span></code>: Idle CPUs in same die(s).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;numa&quot;</span></code>: Idle CPUs in same NUMA node(s).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;l2cache&quot;</span></code>: Idle CPUs sharing same L2 caches.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;core&quot;</span></code>: Idle hyperthreads in same physical cores.</p></li>
</ul>
</li>
<li><p>Containers in all balloon instances of multiple balloon types can be
allowed to run on the same idle CPUs.</p></li>
<li><p>Balloon type’s CPU tuning does not affect these extra CPUs.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">burstable-in-numa</span>
<span class="w">  </span><span class="nt">shareIdleCPUsInSame</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numa</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">one-cpu-with-bonus-thread</span>
<span class="w">  </span><span class="nt">maxCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">shareIdleCPUsInSame</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">core</span>
</pre></div>
</div>
</section>
<section id="hyperthread-visibility">
<h4>Hyperthread Visibility<a class="headerlink" href="#hyperthread-visibility" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">hideHyperthreads</span></code></strong> (boolean, default: <code class="docutils literal notranslate"><span class="pre">false</span></code>)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">true</span></code>: Containers can use only one hyperthread from each physical
core in the balloon.</p>
<ul>
<li><p>Hidden hyperthreads remain completely idle (not available to any
container).</p></li>
<li><p>Useful for workloads that don’t benefit from hyperthreading.</p></li>
<li><p>Balloon with 16 logical CPUs from 8 cores allows using only 8 CPUs.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">false</span></code>: Containers can use all hyperthreads.</p></li>
<li><p>Can be overridden with <code class="docutils literal notranslate"><span class="pre">hide-hyperthreads.resource-policy.nri.io</span></code>
pod annotation that hides hyperthreads only in affected containers
rather than of all containers in certain balloon types.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">compute-intensive</span>
<span class="w">  </span><span class="nt">hideHyperthreads</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
<section id="pod-annotations-for-container-overrides">
<h4>Pod Annotations for Container Overrides<a class="headerlink" href="#pod-annotations-for-container-overrides" title="Link to this heading"></a></h4>
<p>All pod annotations below are effective to all containers in a pod
(annotation key ending <code class="docutils literal notranslate"><span class="pre">.../pod</span></code> or missing <code class="docutils literal notranslate"><span class="pre">/</span></code>), or to named
containers in the pod (key ending <code class="docutils literal notranslate"><span class="pre">.../container.CONTAINER_NAME</span></code>). The
latter override the former.</p>
<p><strong>Balloon type selection:</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloon.balloons.resource-policy.nri.io</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BALLOON_TYPE</span>
<span class="nt">balloon.balloons.resource-policy.nri.io/pod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BALLOON_TYPE</span>
<span class="nt">balloon.balloons.resource-policy.nri.io/container.CONTAINER_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BALLOON_TYPE</span>
</pre></div>
</div>
<p><strong>Scheduling class:</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">scheduling-class.resource-policy.nri.io/container.CONTAINER_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CLASS_NAME</span>
</pre></div>
</div>
<p><strong>Hyperthread hiding:</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">hide-hyperthreads.resource-policy.nri.io/container.CONTAINER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</pre></div>
</div>
<p><strong>Preserve existing pinning (opt-out of policy management):</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">cpu.preserve.resource-policy.nri.io/container.CONTAINER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
<span class="nt">memory.preserve.resource-policy.nri.io/container.CONTAINER_NAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</pre></div>
</div>
<p><strong>Memory type:</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">memory-type.resource-policy.nri.io/container.CONTAINER_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HBM,DRAM</span>
</pre></div>
</div>
</section>
</section>
<section id="cpu-tuning">
<h3>CPU Tuning<a class="headerlink" href="#cpu-tuning" title="Link to this heading"></a></h3>
<p>These options configure CPU behavior and power management.</p>
<p><strong><code class="docutils literal notranslate"><span class="pre">cpuClass</span></code></strong> (string)</p>
<ul class="simple">
<li><p>References a CPU class defined in <code class="docutils literal notranslate"><span class="pre">control.cpu.classes</span></code>
(policy-level configuration).</p></li>
<li><p>Applied when balloon is created, inflated, or deflated.</p></li>
<li><p>Configures frequency scaling and C-states for CPUs in the balloon.</p></li>
</ul>
<p><strong><code class="docutils literal notranslate"><span class="pre">idleCPUClass</span></code></strong> (string, policy-level configuration)</p>
<ul class="simple">
<li><p>CPU class for idle CPUs (not in any balloon).</p></li>
<li><p>Applied when CPUs are removed from balloons.</p></li>
</ul>
<p><strong><code class="docutils literal notranslate"><span class="pre">control.cpu.classes</span></code></strong> (object, policy-level configuration):</p>
<p>Each CPU class (keyed by name) can define:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">minFreq</span></code> (integer): Minimum CPU frequency in kHz.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">maxFreq</span></code> (integer): Maximum CPU frequency in kHz.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uncoreMinFreq</span></code> (integer): Minimum uncore frequency in kHz.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uncoreMaxFreq</span></code> (integer): Maximum uncore frequency in kHz.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">disabledCstates</span></code> (list): C-state names to disable (e.g., <code class="docutils literal notranslate"><span class="pre">[&quot;C6&quot;,</span> <span class="pre">&quot;C8&quot;]</span></code>).</p>
<ul>
<li><p>Disabling deep C-states reduces latency by preventing deep sleep.</p></li>
<li><p>Disabling intermediate C-states keeps CPU more responsive longer
after use, but allows it to enter deeper power saving states if
not needed.</p></li>
<li><p>List available C-states: <code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">.</span> <span class="pre">/sys/devices/system/cpu/cpu0/cpuidle/state*/name</span></code>.</p></li>
</ul>
</li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latency-critical</span>
<span class="w">  </span><span class="nt">cpuClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">turbo</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">best-effort</span>
<span class="w">  </span><span class="nt">cpuClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">normal</span>
<span class="nt">idleCPUClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">powersave</span>

<span class="nt">control</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cpu</span><span class="p">:</span>
<span class="w">    </span><span class="nt">classes</span><span class="p">:</span>
<span class="w">      </span><span class="nt">turbo</span><span class="p">:</span>
<span class="w">        </span><span class="nt">minFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000000</span>
<span class="w">        </span><span class="nt">maxFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3600000</span>
<span class="w">        </span><span class="nt">uncoreMinFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2000000</span>
<span class="w">        </span><span class="nt">uncoreMaxFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2400000</span>
<span class="w">        </span><span class="nt">disabledCstates</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">C6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C10</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">normal</span><span class="p">:</span>
<span class="w">        </span><span class="nt">minFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1200000</span>
<span class="w">        </span><span class="nt">maxFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000000</span>
<span class="w">      </span><span class="nt">powersave</span><span class="p">:</span>
<span class="w">        </span><span class="nt">minFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">800000</span>
<span class="w">        </span><span class="nt">maxFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1200000</span>
</pre></div>
</div>
</section>
<section id="built-in-balloon-types">
<h3>Built-in Balloon Types<a class="headerlink" href="#built-in-balloon-types" title="Link to this heading"></a></h3>
<p>The policy includes two built-in balloon types that can be customized
and whose position in the balloon type list can be changed.</p>
<section id="reserved-balloon">
<h4>Reserved Balloon<a class="headerlink" href="#reserved-balloon" title="Link to this heading"></a></h4>
<p><strong>Purpose</strong>: Runs system containers (typically from <code class="docutils literal notranslate"><span class="pre">kube-system</span></code> namespace)</p>
<p><strong>Default behavior</strong> (when not explicitly defined):</p>
<ul class="simple">
<li><p>Automatically placed first in balloon types list.</p></li>
<li><p>Captures containers from <code class="docutils literal notranslate"><span class="pre">kube-system</span></code> namespace and namespaces
matching <code class="docutils literal notranslate"><span class="pre">reservedPoolNamespaces</span></code>.</p></li>
<li><p>Uses CPUs specified in <code class="docutils literal notranslate"><span class="pre">reservedResources.cpu</span></code>. If a <code class="docutils literal notranslate"><span class="pre">cpuset</span></code> is
defined, those CPUs will be preferred when inflating the reserved
balloon, and correspondingly avoided by other balloons. Reserved
balloon can inflate beyond this cpuset if required by its
containers.</p></li>
</ul>
<p><strong><code class="docutils literal notranslate"><span class="pre">reservedResources</span></code></strong> (policy-level configuration):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cpu</span></code> (string): CPUs for reserved balloon.</p>
<ul>
<li><p>Preferred CPUs: <code class="docutils literal notranslate"><span class="pre">&quot;cpuset:0,48&quot;</span></code> prefers using CPU 0 and 48. Uses
many enough to satisfy container CPU requests, but no more than
that.</p></li>
<li><p>Quantity: <code class="docutils literal notranslate"><span class="pre">&quot;2000m&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;2&quot;</span></code> uses at least 2 CPUs.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">minCPUs</span></code> is explicitly set for <code class="docutils literal notranslate"><span class="pre">reserved</span></code> balloon type, that
overrides the quantity.</p></li>
</ul>
</li>
</ul>
<p><strong><code class="docutils literal notranslate"><span class="pre">reservedPoolNamespaces</span></code></strong> (list of strings, policy-level configuration):</p>
<ul class="simple">
<li><p>Additional namespaces (beyond <code class="docutils literal notranslate"><span class="pre">kube-system</span></code>) assigned to reserved balloon.</p></li>
<li><p>Supports wildcards.</p></li>
</ul>
<p><strong>Customizing reserved balloon:</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Policy-level settings</span>
<span class="nt">reservedResources</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cpuset:0,48</span><span class="w">  </span><span class="c1"># preferred specific CPUs</span>
<span class="nt">reservedPoolNamespaces</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring</span>

<span class="c1"># Explicitly define &#39;reserved&#39; balloon type for more control.</span>
<span class="c1"># Because &quot;reserved&quot; is moved below &quot;own-cpus&quot;, kube-system and</span>
<span class="c1"># monitoring pods with priority=high label will get their own CPUs</span>
<span class="c1"># instead of sharing CPUs with other reserved pods.</span>
<span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">own-cpus</span>
<span class="w">  </span><span class="nt">preferNewBalloons</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod/labels/priority</span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">    </span><span class="nt">values</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">high</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reserved</span><span class="w">  </span><span class="c1"># Must be named &#39;reserved&#39;</span>
<span class="w">  </span><span class="nt">shareIdleCPUsInSame</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numa</span>
</pre></div>
</div>
</section>
<section id="default-balloon">
<h4>Default Balloon<a class="headerlink" href="#default-balloon" title="Link to this heading"></a></h4>
<p><strong>Purpose</strong>: Catches all containers not matched by user-defined balloon types.</p>
<p><strong>Default behavior</strong> (when not explicitly defined):</p>
<ul class="simple">
<li><p>Automatically placed last in balloon types list.</p></li>
<li><p>Captures all remaining containers.</p></li>
<li><p>Uses any remaining CPUs not allocated to other balloons.</p></li>
</ul>
<p><strong>Customizing default balloon:</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="w">  </span><span class="nt">namespaces</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod-*</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w">  </span><span class="c1"># Must be named &#39;default&#39;</span>
<span class="w">  </span><span class="nt">minCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">shareIdleCPUsInSame</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">package</span><span class="w"> </span><span class="c1"># Allow bursting without crossing socket boundary.</span>
<span class="w">  </span><span class="nt">minBalloons</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"> </span><span class="c1"># Create one balloon in both sockets in a 2-socket system.</span>
<span class="w">  </span><span class="nt">maxBallons</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">namespaces</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"> </span><span class="c1"># Match all containers not matched in above types</span>
</pre></div>
</div>
</section>
</section>
<section id="toggle-and-reset-pinning-memory-cpus-and-containers">
<h3>Toggle and Reset Pinning Memory, CPUs, and Containers<a class="headerlink" href="#toggle-and-reset-pinning-memory-cpus-and-containers" title="Link to this heading"></a></h3>
<section id="memory-pinning">
<h4>Memory Pinning<a class="headerlink" href="#memory-pinning" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">pinMemory</span></code></strong> (boolean, policy-level, default: <code class="docutils literal notranslate"><span class="pre">true</span></code>)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">true</span></code>: Pin containers to NUMA nodes closest to their balloon’s CPUs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">false</span></code>: Allow containers to use memory from any NUMA node.</p></li>
<li><p>Can be overridden per balloon type.</p></li>
<li><p>Warning: Pinning may cause OOM kills if pinned memory nodes have
insufficient memory.</p></li>
</ul>
</section>
<section id="cpu-pinning">
<h4>CPU Pinning<a class="headerlink" href="#cpu-pinning" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">pinCPU</span></code></strong> (boolean, policy-level, default: <code class="docutils literal notranslate"><span class="pre">true</span></code>)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">true</span></code>: Restrict containers to their balloon’s CPUs (and optionally
shared idle CPUs).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">false</span></code>: Containers can use any CPUs in the system.</p></li>
<li><p>Usually left as <code class="docutils literal notranslate"><span class="pre">true</span></code> for proper balloon isolation.</p></li>
</ul>
</section>
<section id="managed-cpus">
<h4>Managed CPUs<a class="headerlink" href="#managed-cpus" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">availableResources</span></code></strong> (object, policy-level configuration):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cpu</span></code> (string): CPUset managed by the policy.</p></li>
<li><p>All balloons use only CPUs from this set.</p></li>
<li><p>Useful for reserving CPUs for non-policy-managed workloads.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">availableResources</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cpuset:48-95,144-191</span><span class="w">  </span><span class="c1"># Use only socket 1 in 2-socket system</span>
</pre></div>
</div>
</section>
<section id="managed-containers">
<h4>Managed Containers<a class="headerlink" href="#managed-containers" title="Link to this heading"></a></h4>
<p>The balloons policy can completely ignore selected containers.</p>
<p><strong><code class="docutils literal notranslate"><span class="pre">preserve</span></code></strong> (object, policy-level configuration):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">matchExpressions</span></code> (list): Container match expressions.</p></li>
<li><p>Containers matching these expressions are not managed by the policy.</p></li>
<li><p>Their existing CPU/memory pinning (or lack thereof) is preserved.</p></li>
</ul>
<p>Useful for</p>
<ul>
<li><p>analyzers and other containers that need access to every CPU</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">preserve</span><span class="p">:</span>
<span class="w">  </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name</span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">    </span><span class="nt">values</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">analyzer</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">debugger</span>
</pre></div>
</div>
</li>
<li><p>special containers managed by external policies, for instance on
CPUs not in <code class="docutils literal notranslate"><span class="pre">availableResources</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">preserve</span><span class="p">:</span>
<span class="w">  </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod/labels/non-balloon-cpus</span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Equals</span>
<span class="w">    </span><span class="nt">values</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</pre></div>
</div>
</li>
<li><p>balloons configures only few special containers while others can run
unrestricted on any CPU in the system.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">preserve</span><span class="p">:</span>
<span class="w">  </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod/labels/workload-type</span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NotIn</span>
<span class="w">    </span><span class="nt">values</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;idle&quot;</span>
<span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">idle-workloads</span>
<span class="w">  </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod/labels/workload-type</span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">    </span><span class="nt">values</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;idle&quot;</span>
<span class="w">  </span><span class="nt">schedulingClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">idle</span>
<span class="nt">schedulingClasses</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">idle</span>
<span class="w">  </span><span class="nt">policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">idle</span>
<span class="w">  </span><span class="nt">ioClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">idle</span>
<span class="nt">pinCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">pinMemory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="reset-cpu-and-memory-pinning">
<h4>Reset CPU and Memory Pinning<a class="headerlink" href="#reset-cpu-and-memory-pinning" title="Link to this heading"></a></h4>
<p>Running containers can be “reset” to allow accessing all CPUs and
memories in the system by applying a configuration that pins them
accordingly.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>-<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
<span class="s">apiVersion: config.nri/v1alpha1</span>
<span class="s">kind: BalloonsPolicy</span>
<span class="s">metadata:</span>
<span class="s">  name: default</span>
<span class="s">  namespace: kube-system</span>
<span class="s">spec:</span>
<span class="s">  balloonTypes:</span>
<span class="s">  - name: reserved</span>
<span class="s">    namespaces:</span>
<span class="s">    - &quot;*&quot;</span>
<span class="s">    shareIdleCPUsInSame: system</span>
<span class="s">    # preferIsolCpus: true # uncomment to use kernel isolcpus, too</span>
<span class="s">  reservedResources:</span>
<span class="s">    cpu: 1000m</span>
<span class="s">  pinCPU: true</span>
<span class="s">  pinMemory: true</span>
<span class="s">EOF</span>
</pre></div>
</div>
</section>
</section>
<section id="visibility-scheduling-metrics-logging-debugging">
<h3>Visibility, Scheduling, Metrics, Logging, Debugging<a class="headerlink" href="#visibility-scheduling-metrics-logging-debugging" title="Link to this heading"></a></h3>
<p>These options control observability of balloons and their containers,
including making them visible to Kubernetes scheduler.</p>
<section id="noderesourcetopology-integration">
<h4>NodeResourceTopology Integration<a class="headerlink" href="#noderesourcetopology-integration" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">agent.nodeResourceTopology</span></code></strong> (boolean, policy-level, default:
<code class="docutils literal notranslate"><span class="pre">false</span></code>)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">true</span></code>: Expose balloons as topology zones in
<code class="docutils literal notranslate"><span class="pre">noderesourcetopologies.topology.node.k8s.io</span></code> CRs.</p></li>
<li><p>Enables topology-aware scheduling, exposes created balloon instances
as zones.</p></li>
</ul>
<p><strong><code class="docutils literal notranslate"><span class="pre">showContainersInNrt</span></code></strong> (boolean, can be set at policy-level and
overridden in balloon types, default: <code class="docutils literal notranslate"><span class="pre">false</span></code>)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">true</span></code>: Include container names and resource affinities in
NodeResourceTopology CRs.</p></li>
<li><p>Policy-level setting applies to all balloons by default.</p></li>
<li><p>Balloon-type setting overrides policy-level default.</p></li>
<li><p>Warning: May generate significant API server traffic with many
containers.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Enable topology exposure at policy level</span>
<span class="nt">agent</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodeResourceTopology</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="c1"># Do not show containers in NodeResourceTopology by default.</span>
<span class="nt">showContainersInNrt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="c1"># Override for specific balloon type</span>
<span class="nt">balloonTypes</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">devel</span>
<span class="w">  </span><span class="nt">namespaces</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;devel-*&quot;</span>
<span class="w">  </span><span class="nt">showContainersInNrt</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># Show development container CPU affinities for debugging</span>
</pre></div>
</div>
<p>Example: print all balloons in all nodes in a single table</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>noderesourcetopologies.topology.node.k8s.io<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">  [&quot;NODE&quot;,&quot;BALLOON&quot;,&quot;CPUSET&quot;,&quot;SHARED_CPUSET&quot;],</span>
<span class="s1">  (</span>
<span class="s1">    .items.[] as $node</span>
<span class="s1">    | $node.zones[]</span>
<span class="s1">    | select(.type == &quot;balloon&quot;)</span>
<span class="s1">    | [</span>
<span class="s1">        $node.metadata.name,</span>
<span class="s1">	.name,</span>
<span class="s1">	(.attributes[] | select(.name==&quot;cpuset&quot;) | .value),</span>
<span class="s1">	(.attributes[] | select(.name==&quot;shared cpuset&quot;) | .value)</span>
<span class="s1">      ]</span>
<span class="s1">  )</span>
<span class="s1">  | @tsv&#39;</span>
</pre></div>
</div>
<p>Example: print all containers whose balloon type has effective
<code class="docutils literal notranslate"><span class="pre">showContainersInNrt:</span> <span class="pre">true</span></code> in all nodes</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>noderesourcetopologies.topology.node.k8s.io<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">  [&quot;NODE&quot;,&quot;BALLOON&quot;,&quot;CONTAINER&quot;,&quot;CPUS&quot;,&quot;MEMS&quot;],</span>
<span class="s1">  (</span>
<span class="s1">    .items.[] as $node</span>
<span class="s1">    | $node.zones[]</span>
<span class="s1">    | select(.type == &quot;allocation for container&quot;)</span>
<span class="s1">    | [</span>
<span class="s1">        $node.metadata.name,</span>
<span class="s1">        .parent,</span>
<span class="s1">        .name,</span>
<span class="s1">        (.attributes[] | select(.name==&quot;cpuset&quot;) | .value),</span>
<span class="s1">        (.attributes[] | select(.name==&quot;memory set&quot;) | .value)</span>
<span class="s1">      ]</span>
<span class="s1">  )</span>
<span class="s1">  | @tsv&#39;</span>
</pre></div>
</div>
<p>NodeResourceTopology information can be used in Kubernetes scheduling
through <a class="reference external" href="https://github.com/kubernetes-sigs/scheduler-plugins/blob/master/pkg/noderesourcetopology/README.md">Topology-aware scheduler
plugin</a>.</p>
</section>
<section id="instrumentation-and-metrics">
<h4>Instrumentation and Metrics<a class="headerlink" href="#instrumentation-and-metrics" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">instrumentation</span></code></strong> (object, policy-level configuration):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">httpEndpoint</span></code> (string): HTTP server address (e.g., <code class="docutils literal notranslate"><span class="pre">&quot;:8891&quot;</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">prometheusExport</span></code> (boolean): Enable Prometheus metrics at
<code class="docutils literal notranslate"><span class="pre">/metrics</span></code> endpoint.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reportPeriod</span></code> (string): Aggregation interval for polled metrics
(e.g., <code class="docutils literal notranslate"><span class="pre">&quot;10s&quot;</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metrics.enabled</span></code> (list): Glob patterns for metrics to collect
(e.g., <code class="docutils literal notranslate"><span class="pre">[&quot;policy&quot;]</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">samplingRatePerMillion</span></code> (integer): Tracing sample rate (e.g.,
<code class="docutils literal notranslate"><span class="pre">100000</span></code> for 10%).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tracingCollector</span></code> (string): External tracing endpoint (e.g.,
<code class="docutils literal notranslate"><span class="pre">&quot;otlp-http&quot;</span></code>).</p></li>
</ul>
<p><strong>Available metrics:</strong></p>
<ul class="simple">
<li><p>Balloon instances and their CPUs.</p></li>
<li><p>Containers assigned to each balloon.</p></li>
<li><p>CPU allocation and utilization.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">instrumentation</span><span class="p">:</span>
<span class="w">  </span><span class="nt">httpEndpoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">:8891</span>
<span class="w">  </span><span class="nt">prometheusExport</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">reportPeriod</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class="w">  </span><span class="nt">metrics</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;*&#39;</span><span class="w">  </span><span class="c1"># All metrics</span>
<span class="w">  </span><span class="nt">samplingRatePerMillion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100000</span>
</pre></div>
</div>
<p><strong>Accessing metrics:</strong></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Direct access (if pod IPs are reachable)</span>
<span class="k">for</span><span class="w"> </span>podip<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>-l<span class="w"> </span><span class="s2">&quot;app.kubernetes.io/instance=nri-resource-policy-balloons&quot;</span><span class="w"> </span>-o<span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[*].status.podIP}&#39;</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span>curl<span class="w"> </span>-s<span class="w"> </span>http://<span class="nv">$podip</span>:8891/metrics
<span class="k">done</span>

<span class="c1"># Port forwarding</span>
kubectl<span class="w"> </span>port-forward<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>daemonset/nri-resource-policy-balloons<span class="w"> </span><span class="m">8891</span>:8891<span class="w"> </span><span class="p">&amp;</span>
curl<span class="w"> </span>http://localhost:8891/metrics
</pre></div>
</div>
</section>
<section id="logging-and-debugging">
<h4>Logging and Debugging<a class="headerlink" href="#logging-and-debugging" title="Link to this heading"></a></h4>
<p><strong><code class="docutils literal notranslate"><span class="pre">log</span></code></strong> (object, policy-level configuration):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">debug</span></code> (list): List of components to enable debug logging for.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">nri-plugin</span></code> - NRI communication with the container runtime</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">policy</span></code> for balloons policy</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">expression</span></code> for matchExpression and groupBy expressions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cache</span></code> for container and pod cache</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cpu</span></code> for low-level CPU tuning controls (frequencies, cstates)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cpuallocator</span></code> for lowest-level CPU allocator below the policy</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sysfs</span></code> for hardware discovery</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;*&quot;</span></code> for all</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">source</span></code> (boolean): Prefix messages with logger source name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">klog</span></code> (object): klog-specific options (see klog documentation).</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">log</span><span class="p">:</span>
<span class="w">  </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nri-plugin</span>
<span class="w">  </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">klog</span><span class="p">:</span>
<span class="w">    </span><span class="nt">skip_headers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p><strong>View logs:</strong></p>
<p>Show policy decision in assigning container CTRNAME in PODNAME in NAMESPACE to a balloon:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>daemonset/nri-resource-policy-balloons<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;assigning container NAMESPACE/PODNAME/CTRNAME&#39;</span>
</pre></div>
</div>
<p><strong>Inspect container information and cgroups:</strong></p>
<p>Inspect container CTRNAME in PODNAME in NAMESPACE:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">CTR_ID</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span>NAMESPACE<span class="w"> </span>PODNAME<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.containerStatuses[?(@.name==&quot;CTRNAME&quot;)].containerID}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s|^[^:]*://||&#39;</span><span class="k">)</span>
crictl<span class="w"> </span>inspect<span class="w"> </span><span class="nv">$CTR_ID</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>.info.runtimeSpec
</pre></div>
</div>
<p>Read effective CPU and memory sets from cgroups on the local node with the <code class="docutils literal notranslate"><span class="pre">kube-cgroups</span></code> script.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-OL<span class="w"> </span>https://raw.githubusercontent.com/containers/nri-plugins/refs/heads/main/scripts/testing/kube-cgroups
chmod<span class="w"> </span>a+rx<span class="w"> </span>kube-cgroups
./kube-cgroups<span class="w"> </span>-n<span class="w"> </span>NAMESPACE<span class="w"> </span>-p<span class="w"> </span>PODNAME<span class="w"> </span>-c<span class="w"> </span>CTRNAME<span class="w"> </span>-f<span class="w"> </span><span class="s1">&#39;cpuset.cpus.effective|cpuset.mems.effective&#39;</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="cookbook">
<h2>Cookbook<a class="headerlink" href="#cookbook" title="Link to this heading"></a></h2>
<section id="latency-critical-containers">
<h3>Latency-Critical Containers<a class="headerlink" href="#latency-critical-containers" title="Link to this heading"></a></h3>
<p><strong>Goal</strong>: Minimize latency by preventing cache sharing and optimizing
CPU configuration.</p>
<p><strong>Requirements:</strong></p>
<ul class="simple">
<li><p>Containers should not share L2 cache to avoid cache contention.</p></li>
<li><p>CPUs should run at maximum frequency.</p></li>
<li><p>Disable deep C-states to avoid wakeup latency.</p></li>
<li><p>Each container gets dedicated CPUs (no sharing between containers).</p></li>
</ul>
<p><strong>Configuration:</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config.nri/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BalloonsPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">reservedResources</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2&quot;</span>
<span class="w">  </span><span class="nt">pinCPU</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">pinMemory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">allocatorTopologyBalancing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># Pack tightly for power efficiency</span>
<span class="w">  </span><span class="nt">idleCPUClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">powersave</span><span class="w"> </span><span class="c1"># Force to minimal frequencies for external processes</span>

<span class="w">  </span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ultra-low-latency</span>
<span class="w">    </span><span class="c1"># Match latency-critical containers</span>
<span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod/labels/latency</span>
<span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">      </span><span class="nt">values</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>

<span class="w">    </span><span class="c1"># Fixed size, pre-created balloons</span>
<span class="w">    </span><span class="nt">minBalloons</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">    </span><span class="nt">minCPUs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="w">    </span><span class="nt">allocatorPriority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">high</span>

<span class="w">    </span><span class="c1"># Each container gets its own balloon</span>
<span class="w">    </span><span class="nt">preferNewBalloons</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">    </span><span class="c1"># CPU configuration for minimal latency</span>
<span class="w">    </span><span class="nt">cpuClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ultra-low-latency</span>

<span class="w">    </span><span class="nt">schedulingClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">realtime</span>

<span class="w">    </span><span class="c1"># Mark CPUs as generating cache load</span>
<span class="w">    </span><span class="nt">loads</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">l2-intensive</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">    </span><span class="nt">namespaces</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;*&quot;</span>
<span class="w">    </span><span class="nt">loads</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">l2-intensive</span><span class="w"> </span><span class="c1"># avoid sharing L2 domains with critical containers</span>
<span class="w">    </span><span class="nt">cpuClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">normal</span><span class="w"> </span><span class="c1"># low to mid GHz to save power budget for critical containers</span>

<span class="w">  </span><span class="c1"># Define L2 cache load to prevent containers in other balloons from sharing cache</span>
<span class="w">  </span><span class="nt">loadClasses</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">l2-intensive</span>
<span class="w">    </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">l2cache</span>
<span class="w">    </span><span class="nt">overloadsLevelInBalloon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># Share L2 between CPUs within balloon</span>

<span class="w">  </span><span class="c1"># CPU classes for frequency and C-state control</span>
<span class="w">  </span><span class="nt">control</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cpu</span><span class="p">:</span>
<span class="w">      </span><span class="nt">classes</span><span class="p">:</span>
<span class="w">        </span><span class="nt">ultra-low-latency</span><span class="p">:</span>
<span class="w">          </span><span class="nt">minFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3500000</span>
<span class="w">          </span><span class="nt">maxFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3900000</span>
<span class="w">          </span><span class="nt">uncoreMinFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2400000</span>
<span class="w">          </span><span class="nt">uncoreMaxFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2400000</span>
<span class="w">          </span><span class="nt">disabledCstates</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">C6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C7</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">C10</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">normal</span><span class="p">:</span>
<span class="w">          </span><span class="nt">minFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">800000</span>
<span class="w">          </span><span class="nt">maxFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2500000</span>
<span class="w">        </span><span class="nt">powersave</span><span class="p">:</span>
<span class="w">          </span><span class="nt">minFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">800000</span>
<span class="w">          </span><span class="nt">maxFreq</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">800000</span>

<span class="w">  </span><span class="c1"># Scheduling for high priority</span>
<span class="w">  </span><span class="nt">schedulingClasses</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">realtime</span>
<span class="w">    </span><span class="nt">policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fifo</span>
<span class="w">    </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">    </span><span class="nt">ioClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rt</span>
<span class="w">    </span><span class="nt">ioPriority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</pre></div>
</div>
<p><strong>Pod annotation example:</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latency-critical-app</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">latency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-app:latest</span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">      </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
</pre></div>
</div>
</section>
<section id="maximum-memory-bandwidth-containers">
<h3>Maximum Memory Bandwidth Containers<a class="headerlink" href="#maximum-memory-bandwidth-containers" title="Link to this heading"></a></h3>
<p><strong>Goal</strong>: Maximize memory bandwidth by two alternative means:</p>
<ol class="arabic simple">
<li><p>balancing memory-bandwidth balloons across multiple NUMA nodes,
each balloon using only the local (lowest-latency) memory nodes.</p></li>
<li><p>balancing each memory-bandwidth balloon to have equal number of
CPUs from both NUMA nodes of single socket. These balloons are
then balanced between sockets.</p></li>
</ol>
<p><strong>Requirements:</strong></p>
<ul class="simple">
<li><p>CPUs from multiple NUMA nodes to access multiple memory channels.</p></li>
<li><p>Balanced distribution across topology for maximum bandwidth.</p></li>
<li><p>Containers can be large, using many CPUs.</p></li>
</ul>
<p><strong>Configuration 1: Local NUMA accesses only</strong></p>
<p>For 2-socket 4-NUMA-node system where each where pods labelled
“memory-intensive” should be restricted to use local NUMA only in both
CPU and memory. Other pods should share all CPUs of either socket
except for CPUs reserved for workloads memory-intensive workloads.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config.nri/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BalloonsPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">reservedResources</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cpuset:0</span>
<span class="w">  </span><span class="nt">pinCPU</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">pinMemory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">allocatorTopologyBalancing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># Spread across NUMA nodes</span>

<span class="w">  </span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">memory-bandwidth</span>
<span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod/labels/workload-type</span>
<span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">      </span><span class="nt">values</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">memory-intensive</span>
<span class="w">    </span><span class="c1"># Each workload gets its own balloon</span>
<span class="w">    </span><span class="nt">preferNewBalloons</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">    </span><span class="c1"># create one default balloon per socket for other workloads</span>
<span class="w">    </span><span class="nt">minBalloons</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">shareIdleCPUsInSame</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">package</span>
</pre></div>
</div>
<p><strong>Configuration 2: balanced CPUs from both NUMAs of either socket</strong></p>
<p>For a 2-socket 4-NUMA-node system where each container needs an equal
number of CPUs from all NUMAs of either package, but needs to avoid
cross-socket allocation.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">max-bandwidth-either-package</span>
<span class="w">    </span><span class="c1"># Composite balloon combining CPUs from all NUMA nodes from either package</span>
<span class="w">    </span><span class="nt">components</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">balloonType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">max-bandwidth-package0</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">balloonType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">max-bandwidth-package1</span>
<span class="w">    </span><span class="nt">componentCreation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">balance-balloons</span>
<span class="w">    </span><span class="nt">preferNewBalloons</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod/labels/workload-type</span>
<span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">      </span><span class="nt">values</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">max-bandwidth</span>

<span class="w">  </span><span class="c1"># Component balloon types - one per package</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">max-bandwidth-package0</span>
<span class="w">    </span><span class="nt">components</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">balloonType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numa0</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">balloonType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numa1</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">max-bandwidth-package1</span>
<span class="w">    </span><span class="nt">components</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">balloonType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numa2</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">balloonType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numa3</span>

<span class="w">  </span><span class="c1"># Component balloon types - one per NUMA</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numa0</span>
<span class="w">    </span><span class="nt">preferCloseToDevices</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/devices/system/node/node0</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numa1</span>
<span class="w">    </span><span class="nt">preferCloseToDevices</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/devices/system/node/node1</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numa2</span>
<span class="w">    </span><span class="nt">preferCloseToDevices</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/devices/system/node/node2</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numa3</span>
<span class="w">    </span><span class="nt">preferCloseToDevices</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/devices/system/node/node3</span>
</pre></div>
</div>
</section>
<section id="workload-aware-hyperthread-sharing">
<h3>Workload-Aware Hyperthread Sharing<a class="headerlink" href="#workload-aware-hyperthread-sharing" title="Link to this heading"></a></h3>
<p><strong>Goal</strong>: Optimize physical core utilization by controlling which
workload types share cores.</p>
<p><strong>Scenario:</strong></p>
<ul class="simple">
<li><p><strong>Type A workloads</strong>: High CPU utilization, always running (e.g.,
batch processing), no bursts.</p></li>
<li><p><strong>Type B workloads</strong>: Bursty, short-duration spikes (e.g., request
handling). Benefit from temporarily using more CPUs than requested.</p></li>
<li><p><strong>Type C workloads</strong>: Low priority background tasks. Benefit from
from extra CPUs but must not slow down type B workloads.</p></li>
</ul>
<p><strong>Strategy:</strong></p>
<ul class="simple">
<li><p>Prevent two Type A workloads from sharing physical cores (would
compete heavily).</p></li>
<li><p>Allow Type A + Type B on same physical cores.</p></li>
<li><p>Allow Type A + Type C on same physical cores.</p></li>
<li><p>Allow Type B and C use extra available CPUs.</p></li>
<li><p>Prioritize running Type B over Type C on shared CPUs.</p></li>
</ul>
<p><strong>Configuration:</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config.nri/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BalloonsPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">reservedResources</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2&quot;</span>
<span class="w">  </span><span class="nt">pinCPU</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">pinMemory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">allocatorTopologyBalancing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">  </span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always-running-batch</span>
<span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod/labels/workload-pattern</span>
<span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">      </span><span class="nt">values</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always-running</span>
<span class="w">    </span><span class="c1"># Mark as generating sustained core load</span>
<span class="w">    </span><span class="nt">loads</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sustained-compute</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bursty-requests</span>
<span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod/labels/workload-pattern</span>
<span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">      </span><span class="nt">values</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bursty</span>
<span class="w">    </span><span class="nt">schedulingClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">high-priority</span>
<span class="w">    </span><span class="c1"># Allow bursting within NUMA node scope.</span>
<span class="w">    </span><span class="nt">shareIdleCPUsInSame</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numa</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">background-tasks</span>
<span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod/labels/workload-pattern</span>
<span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">      </span><span class="nt">values</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">background</span>
<span class="w">    </span><span class="c1"># No loads specified - can share cores with anything.</span>
<span class="w">    </span><span class="nt">schedulingClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">low-priority</span>
<span class="w">    </span><span class="c1"># Allow bursting within NUMA node scope.</span>
<span class="w">    </span><span class="nt">shareIdleCPUsInSame</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">numa</span>

<span class="w">  </span><span class="c1"># Define sustained compute load</span>
<span class="w">  </span><span class="nt">loadClasses</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sustained-compute</span>
<span class="w">    </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">core</span>

<span class="w">  </span><span class="nt">schedulingClasses</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">high-priority</span>
<span class="w">    </span><span class="nt">nice</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-10</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">low-priority</span>
<span class="w">    </span><span class="nt">policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch</span>
<span class="w">    </span><span class="nt">nice</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">    </span><span class="nt">ioClass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">idle</span>
</pre></div>
</div>
<p><strong>How it works:</strong></p>
<ol class="arabic simple">
<li><p><strong>always-running-batch</strong> balloons declare <code class="docutils literal notranslate"><span class="pre">sustained-compute</span></code> load
with <code class="docutils literal notranslate"><span class="pre">overloadsLevelInBalloon:</span> <span class="pre">true</span></code>.</p>
<ul class="simple">
<li><p>CPUs allocated from different physical cores within each balloon.</p></li>
<li><p>When multiple such balloons exist, they avoid each other’s cores.</p></li>
</ul>
</li>
<li><p><strong>bursty-requests</strong> and <strong>background-tasks</strong> balloons don’t declare
any loads.</p>
<ul class="simple">
<li><p>Can be allocated to hyperthreads on cores already used by
always-running-batch.</p></li>
</ul>
</li>
<li><p>Containers in <strong>bursty-requests</strong> and <strong>background-tasks</strong> balloons
share idle CPUs in the same NUMA nodes.</p>
<ul class="simple">
<li><p>They get CPU scheduling priority (bursty) or depriority
(background) to manage competition.</p></li>
</ul>
</li>
<li><p>Result: Physical cores are shared between complementary workloads,
maximizing utilization without excessive competition.</p></li>
</ol>
<p><strong>Pod annotation examples:</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Always-running batch job</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data-processing</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">workload-pattern</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always-running</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">processor</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch-processor:latest</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>

<span class="nn">---</span>
<span class="c1"># Bursty request handler</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api-server</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">workload-pattern</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bursty</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api-server:latest</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2&quot;</span>

<span class="nn">---</span>
<span class="c1"># Background task</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CronJob</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">log-aggregator</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*/5</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span>
<span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">template</span><span class="p">:</span>
<span class="w">        </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">          </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">            </span><span class="nt">workload-pattern</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">background</span>
<span class="w">        </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">          </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aggregator</span>
<span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">log-aggregator:latest</span>
<span class="w">            </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">              </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">                </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
</pre></div>
</div>
<p><strong>Advanced: Fine-grained control with L2 cache awareness</strong></p>
<p>For workloads where L2 cache contention is also a concern:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nt">balloonTypes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-sensitive-batch</span>
<span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod/labels/workload-pattern</span>
<span class="w">      </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">      </span><span class="nt">values</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-sensitive</span>
<span class="w">    </span><span class="nt">loads</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sustained-compute</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">l2-cache-intensive</span>

<span class="w">  </span><span class="nt">loadClasses</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sustained-compute</span>
<span class="w">    </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">core</span>
<span class="w">    </span><span class="nt">overloadsLevelInBalloon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">l2-cache-intensive</span>
<span class="w">    </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">l2cache</span>
<span class="w">    </span><span class="nt">overloadsLevelInBalloon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># Allow cache sharing within balloon</span>
</pre></div>
</div>
<p>This prevents cache-sensitive workloads from sharing L2 caches across
balloons while still allowing it within a balloon.</p>
</section>
</section>
<hr class="docutils" />
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading"></a></h2>
<p><strong>Issue</strong>: Containers not being assigned to expected balloons or
Balloons not getting desired CPUs</p>
<p><strong>Solution</strong>: Check the balloon type matching order and CPU allocation from logs with</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">log</span><span class="p">:</span>
<span class="w">  </span><span class="nt">debug</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy</span>
</pre></div>
</div>
<p><strong>Issue</strong>: Out of memory errors with <code class="docutils literal notranslate"><span class="pre">pinMemory:</span> <span class="pre">true</span></code></p>
<p><strong>Solution</strong>: Either disable memory pinning or ensure sufficient memory on each NUMA node:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">pinMemory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
<p><strong>Issue</strong>: Policy not applying configuration changes</p>
<p><strong>Solution</strong>:</p>
<ul>
<li><p>Verify that <code class="docutils literal notranslate"><span class="pre">nri-resource-policy-balloons-...</span></code> pod is running.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>daemonset/nri-resource-policy-balloons
kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>nri-resource-policy-balloons-...
</pre></div>
</div>
</li>
<li><p>Verify the configuration object (BalloonsPolicy) exists, is valid, is named
correctly (<code class="docutils literal notranslate"><span class="pre">default</span></code>, <code class="docutils literal notranslate"><span class="pre">group.GROUPNAME</span></code> or <code class="docutils literal notranslate"><span class="pre">node.NODENAME</span></code>) and is in the
same namespace as the pod.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>balloonspolicies.config.nri<span class="w"> </span>-n<span class="w"> </span>kube-system
</pre></div>
</div>
</li>
<li><p>Verify node labels. If a node has a <code class="docutils literal notranslate"><span class="pre">config.nri/group=GROUPNAME</span></code>
label, it will not use BalloonsPolicy named <code class="docutils literal notranslate"><span class="pre">default</span></code>, only
<code class="docutils literal notranslate"><span class="pre">group.GROUPNAME</span></code> or <code class="docutils literal notranslate"><span class="pre">node.NODENAME</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>node<span class="w"> </span>NODENAME<span class="w"> </span>--show-labels
</pre></div>
</div>
</li>
<li><p>If necessary, delete the policy pod, let the DaemonSet re-create it
and look for “config” issues in the log.</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>nri-resource-policy-balloons-...
kubectl<span class="w"> </span>logs<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>nri-resource-policy-balloons-...
</pre></div>
</div>
<p><strong>Issue</strong>: System unresponsive or performance drop after
configuration change</p>
<p><strong>Solution</strong>:</p>
<ul class="simple">
<li><p>Delete all workloads, especially those with large memory footprint,
before changing a configuration. Pinning their memory to different
nodes may cause large node-to-node memory migrations, causing
unresponsiveness even up to minutes.</p></li>
<li><p>Redeploy performance critical workloads only after configuration
updateds. That ensures their processes get started and data aligned
in memory as configured.</p></li>
<li><p>Make sure important containers request CPUs. Check if BestEffort and
Burstable containers without CPU requests are still allowed to use
enough CPUs (see <code class="docutils literal notranslate"><span class="pre">shareIdleCPUsInSame</span></code>) instead of getting all
packed on a single CPU.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="topology-aware.html" class="btn btn-neutral float-left" title="Topology-Aware Policy" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="template.html" class="btn btn-neutral float-right" title="Template Policy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, various.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
  
    <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
      <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> GitHub Pages</span>
        devel
        <span class="fa fa-caret-down"></span>
      </span>
      <div class="rst-other-versions">
        <dl id="versions">
          <dt>Versions</dt>
        </dl>
        <dl>
          <dt>
          <a href="/nri-plugins/releases">all releases</a>
          </dt>
        </dl>
      </div>
    </div>
  
  <script src="../../../../versions.js"></script>
  <script>
      var list = document.getElementById('versions')
      var menuItems = getVersionsMenuItems();
      for (var i=0; i < menuItems.length; i++) {
        var item = document.createElement('dd');
        var anchor = item.appendChild(document.createElement('a'));
        anchor.appendChild(document.createTextNode(menuItems[i].name));
        anchor.href = menuItems[i].url;
        list.appendChild(item);
      }
  </script>


</body>
</html>